name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  discussions: write

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ä»¥ç”Ÿæˆ changelog
          
      - name: éªŒè¯ Tag æ ¼å¼
        id: validate
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºè¯­ä¹‰åŒ–ç‰ˆæœ¬
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Tag æ ¼å¼ä¸ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ: $TAG_NAME"
            echo "âœ… æ­£ç¡®æ ¼å¼ç¤ºä¾‹: v1.0.0, v1.0.0-beta.1, v1.0.0-rc.1"
            exit 1
          fi
          
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "$TAG_NAME" =~ -[a-zA-Z] ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ æ£€æµ‹åˆ°é¢„å‘å¸ƒç‰ˆæœ¬: $TAG_NAME"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "ðŸŽ‰ æ£€æµ‹åˆ°æ­£å¼ç‰ˆæœ¬: $TAG_NAME"
          fi
          
          # æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰ v å‰ç¼€ï¼‰
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: ç”Ÿæˆ Changelog
        id: changelog
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ðŸ“ é¦–æ¬¡å‘å¸ƒï¼Œç”Ÿæˆå®Œæ•´ Changelog"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "ðŸ“ ç”Ÿæˆä»Ž $PREVIOUS_TAG åˆ° ${{ steps.validate.outputs.tag_name }} çš„ Changelog"
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # æŒ‰ç±»åž‹åˆ†ç±» Changelog
          FEATURES=$(echo "$CHANGELOG" | grep -i "^- feat" || true)
          FIXES=$(echo "$CHANGELOG" | grep -i "^- fix" || true)
          DOCS=$(echo "$CHANGELOG" | grep -i "^- docs" || true)
          REFACTOR=$(echo "$CHANGELOG" | grep -i "^- refactor" || true)
          CHORE=$(echo "$CHANGELOG" | grep -i "^- chore" || true)
          OTHER=$(echo "$CHANGELOG" | grep -v -i "^- \(feat\|fix\|docs\|refactor\|chore\)" || true)
          
          # æž„å»ºå®Œæ•´çš„ Changelog
          FULL_CHANGELOG="## ðŸ“‹ æ›´æ–°å†…å®¹"$'\n\n'
          
          if [ ! -z "$FEATURES" ]; then
            FULL_CHANGELOG+="### âœ¨ æ–°åŠŸèƒ½"$'\n'
            FULL_CHANGELOG+="$FEATURES"$'\n\n'
          fi
          
          if [ ! -z "$FIXES" ]; then
            FULL_CHANGELOG+="### ðŸ› Bug ä¿®å¤"$'\n'
            FULL_CHANGELOG+="$FIXES"$'\n\n'
          fi
          
          if [ ! -z "$DOCS" ]; then
            FULL_CHANGELOG+="### ðŸ“– æ–‡æ¡£æ›´æ–°"$'\n'
            FULL_CHANGELOG+="$DOCS"$'\n\n'
          fi
          
          if [ ! -z "$REFACTOR" ]; then
            FULL_CHANGELOG+="### â™»ï¸ ä»£ç é‡æž„"$'\n'
            FULL_CHANGELOG+="$REFACTOR"$'\n\n'
          fi
          
          if [ ! -z "$CHORE" ]; then
            FULL_CHANGELOG+="### ðŸ”§ å…¶ä»–æ›´æ”¹"$'\n'
            FULL_CHANGELOG+="$CHORE"$'\n\n'
          fi
          
          if [ ! -z "$OTHER" ]; then
            FULL_CHANGELOG+="### ðŸ“¦ å…¶ä»–æäº¤"$'\n'
            FULL_CHANGELOG+="$OTHER"$'\n\n'
          fi
          
          # ä¿å­˜ Changelog åˆ°æ–‡ä»¶
          echo "$FULL_CHANGELOG" > changelog.md
          
          # è¾“å‡ºæ‘˜è¦
          echo "### ðŸ“ Changelog ç”ŸæˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat changelog.md >> $GITHUB_STEP_SUMMARY
          
      - name: åˆ›å»º Release è¯´æ˜Ž
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # Queqiao-arr ${{ steps.validate.outputs.tag_name }}
          
          $(cat changelog.md)
          
          ## ðŸ³ Docker é•œåƒ
          
          ```bash
          # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
          docker pull leiax00/queqiao-arr:${{ steps.validate.outputs.version }}
          
          # æ‹‰å– latestï¼ˆä»…æ­£å¼ç‰ˆæœ¬ï¼‰
          docker pull leiax00/queqiao-arr:latest
          ```
          
          **æ”¯æŒå¹³å°:**
          - `linux/amd64` - x86_64 æž¶æž„
          - `linux/arm64` - ARM64 æž¶æž„ï¼ˆå¦‚æ ‘èŽ“æ´¾ 4+ã€Apple Siliconï¼‰
          
          ## ðŸ“¦ å¿«é€Ÿéƒ¨ç½²
          
          ### Docker Composeï¼ˆæŽ¨èï¼‰
          
          ```bash
          # å…‹éš†é¡¹ç›®
          git clone https://github.com/leiax00/queqiao-arr.git
          cd queqiao-arr
          
          # åˆ‡æ¢åˆ°æ­¤ç‰ˆæœ¬
          git checkout ${{ steps.validate.outputs.tag_name }}
          
          # é…ç½®çŽ¯å¢ƒå˜é‡
          cp .env.example .env
          # ç¼–è¾‘ .env æ–‡ä»¶
          
          # å¯åŠ¨æœåŠ¡
          docker-compose -f docker-compose.prod.yml up -d
          ```
          
          ### ç›´æŽ¥è¿è¡Œ
          
          ```bash
          docker run -d \
            --name queqiao-arr \
            -p 8000:8000 \
            -v queqiao-data:/app/data \
            -v queqiao-logs:/app/logs \
            -e SECRET_KEY=your-secret-key \
            -e TMDB_API_KEY=your-tmdb-api-key \
            leiax00/queqiao-arr:${{ steps.validate.outputs.version }}
          ```
          
          ## ðŸ“š æ–‡æ¡£
          
          - [é¡¹ç›®ä¸»é¡µ](https://github.com/leiax00/queqiao-arr)
          - [Docker éƒ¨ç½²æŒ‡å—](https://github.com/leiax00/queqiao-arr/blob/main/DOCKER_README.md)
          - [API æ–‡æ¡£](http://localhost:8000/api/docs) (å¯åŠ¨åŽè®¿é—®)
          
          ## ðŸ†™ å‡çº§è¯´æ˜Ž
          
          EOF
          
          # æ·»åŠ å‡çº§è¯´æ˜Žï¼ˆæ ¹æ®ç‰ˆæœ¬ç±»åž‹ï¼‰
          if [ "${{ steps.validate.outputs.is_prerelease }}" == "true" ]; then
            cat >> release_notes.md << 'EOF'
          âš ï¸ **è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬**ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ã€‚å»ºè®®åœ¨æµ‹è¯•çŽ¯å¢ƒä¸­ä½¿ç”¨ã€‚
          
          å‡çº§æ­¥éª¤ï¼š
          1. å¤‡ä»½æ•°æ®åº“å’Œé…ç½®æ–‡ä»¶
          2. æ‹‰å–æ–°é•œåƒï¼š`docker pull leiax00/queqiao-arr:${{ steps.validate.outputs.version }}`
          3. é‡å¯å®¹å™¨ï¼š`docker-compose restart`
          4. æ£€æŸ¥æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸ
          
          EOF
          else
            cat >> release_notes.md << 'EOF'
          å‡çº§æ­¥éª¤ï¼š
          1. å¤‡ä»½æ•°æ®åº“å’Œé…ç½®æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
          2. åœæ­¢å½“å‰å®¹å™¨ï¼š`docker-compose down`
          3. æ‹‰å–æ–°é•œåƒï¼š`docker pull leiax00/queqiao-arr:${{ steps.validate.outputs.version }}`
          4. å¯åŠ¨æ–°å®¹å™¨ï¼š`docker-compose up -d`
          5. æ£€æŸ¥æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸï¼š`docker-compose logs -f`
          
          EOF
          fi
          
          # æ·»åŠ å¸¸è§é—®é¢˜
          cat >> release_notes.md << 'EOF'
          ## â“ å¸¸è§é—®é¢˜
          
          **Q: å¦‚ä½•æŸ¥çœ‹å®Œæ•´çš„æäº¤åŽ†å²ï¼Ÿ**  
          A: è®¿é—® [å®Œæ•´ Changelog](https://github.com/leiax00/queqiao-arr/compare/$PREVIOUS_TAG...${{ steps.validate.outputs.tag_name }})
          
          **Q: é‡åˆ°é—®é¢˜å¦‚ä½•åé¦ˆï¼Ÿ**  
          A: è¯·åœ¨ [Issues](https://github.com/leiax00/queqiao-arr/issues) é¡µé¢æäº¤é—®é¢˜
          
          **Q: å¦‚ä½•å›žæ»šåˆ°æ—§ç‰ˆæœ¬ï¼Ÿ**  
          A: ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„é•œåƒæ ‡ç­¾ï¼Œä¾‹å¦‚ï¼š`leiax00/queqiao-arr:1.0.0`
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—:** https://github.com/leiax00/queqiao-arr/blob/${{ steps.validate.outputs.tag_name }}/docs/CHANGELOG.md
          
          EOF
          
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.validate.outputs.tag_name }}
          body_path: release_notes.md
          prerelease: ${{ steps.validate.outputs.is_prerelease }}
          draft: false
          generate_release_notes: false
          discussion_category_name: Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "### ðŸŽ‰ Release å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ steps.validate.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ç±»åž‹:** ${{ steps.validate.outputs.is_prerelease == 'true' && 'é¢„å‘å¸ƒç‰ˆæœ¬' || 'æ­£å¼ç‰ˆæœ¬' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker é•œåƒ:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull leiax00/queqiao-arr:${{ steps.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release é“¾æŽ¥:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.validate.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY

