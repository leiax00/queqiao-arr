# **产品需求文档 (PRD): Queqiao-arr**

## 1. 文档版本历史

| 版本号 | 日期 | 作者 | 修订说明 |
| :--- | :--- | :--- | :--- |
| V1.0 | 2025-09-15 | Gemini | 初稿，基于双方讨论结果创建，定义了MVP范围内的所有核心需求，并确定了项目正式名称。 |

## 2. 项目概述 (Project Overview)

### 2.1. 项目背景 (Background)
当前，许多影音爱好者使用以Sonarr为代表的“arr”系列工具来自动化管理个人媒体库。然而，这套生态系统在处理中文内容，特别是国漫（中国动画）时，由于元数据来源（如TheTVDB）对中文支持不佳，以及中文社区独特的资源发布命名习惯，导致Sonarr无法有效、自动地完成“搜索-匹配-下载”的流程。用户“小张”们不得不花费大量时间手动搜索和添加任务，严重破坏了自动化体验的完整性。

### 2.2. 问题陈述 (Problem Statement)
Sonarr在自动化处理国漫时，因无法准确匹配拼音/英文标题与中文发布资源标题，导致搜索失败、解析错误率高，无法实现“无人值守”的自动化下载，给中文社区用户带来了持续的挫败感。

### 2.3. 项目目标 (Goals & Objectives)
本项目旨在开发一款名为 **Queqiao-arr** 的Web用户界面中间代理服务，无缝集成到用户现有的arr工作流中。它通过引入TMDB等对中文更友好的元数据源，智能地增强和翻译Sonarr的搜索请求，并精确解析中文发布资源，从而实现国漫的高度自动化下载。

**SMART原则目标:**

- **(S)pecific:** 开发一个Web代理服务，拦截Sonarr请求，利用TMDB别名增强搜索，解析结果并以标准化格式返回给Sonarr。
- **(M)easurable:** MVP版本发布后，对于新添加的国漫剧集，实现 **80%** 的剧集能够被全自动识别并成功推送至下载客户端。
- **(A)chievable:** 核心功能基于对现有稳定API的调用和数据处理，技术上完全可行。
- **(R)elevant:** 直接解决中文arr生态用户的核心痛点，完善自动化体验。
- **(T)ime-bound:** 计划在 **3个月** 内完成MVP版本的开发、测试和发布。

### 2.4. 成功指标 (Success Metrics)
- **核心指标:** 国漫剧集自动匹配成功率 > 80%。
- **次要指标:** 用户手动干预率 < 20%。
- **用户体验指标:** 新用户首次配置平均耗时 < 5分钟。

## 3. 用户角色与画像 (User Personas)
- **画像名称:** 小张 (Alex)
- **背景:** 28岁，互联网从业者，影音爱好者。业余时间搭建了NAS家庭影音服务器（Jellyfin/Plex + arr套件）。
- **技术水平:** 能够按教程完成软件安装配置，理解Docker等基本概念，偏爱有图形化界面的工具。
- **核心痛点:** 享受arr套件的自动化，但在添加国漫时，因无法自动识别而被迫手动操作，感到自动化体验被割裂和破坏。
- **期望:** 渴望一个“即插即用”的工具，能像“汉化补丁”一样，让Sonarr管理国漫也能顺畅、全自动。配置需简单直观。

## 4. 用户旅程图 (User Journey Map)
1.  **安装与配置:** 小张发现并部署**Queqiao-arr**。首次访问Web UI，创建管理员账户，随后在设置页面填入Sonarr、Prowlarr的连接信息和网络代理（可选），最后将本工具作为索引器添加至Sonarr。
2.  **日常使用:** 小张像往常一样，在Sonarr中搜索并添加一部新的国漫。
3.  **自动化处理 (后台):** **Queqiao-arr**自动拦截Sonarr请求，通过TMDB获取中文别名，向Prowlarr发起精准搜索，解析返回结果，并将标准化数据响应给Sonarr。
4.  **成功下载:** Sonarr从**Queqiao-arr**的响应中找到满意的结果，并将其发送给下载客户端（如qBittorrent）执行下载。整个过程用户无感知。

## 5. 功能需求 (Functional Requirements) - MVP

### **功能模块 1: 初始设置与认证 (Onboarding & Authentication)**

**用户故事 1.1: 首次运行时创建管理员账户**
* **As a** 首次使用者, **I want to** 在第一次访问Web界面时创建管理员账户, **so that** 我可以立即保护我的应用实例。
* **验收标准:**
  * **Given** 系统首次运行且无账户存在，**When** 访问Web UI，**Then** 看到的是注册页面。
  * **Given** 在注册页面输入信息并提交，**When** 创建成功，**Then** 自动登录并跳转至主设置页。
  * **Given** 账户已存在，**When** 访问Web UI，**Then** 看到的是登录页面。

**用户故事 1.2: 用户登录**
* **As a** 返回的用户, **I want to** 使用我的用户名和密码登录, **so that** 我可以安全地访问和管理我的配置。
* **验收标准:**
  * **Given** 在登录页输入正确凭据，**When** 点击登录，**Then** 成功登录并进入主界面。
  * **Given** 在登录页输入错误凭据，**When** 点击登录，**Then** 提示错误且仍停留在登录页。

**用户故事 1.3: 配置网络代理**
* **As a** 用户, **I want to** 在设置页面配置HTTP或SOCKS5代理, **so that** 工具访问外部API（如TMDB）时能确保网络可用性。
* **验收标准:**
  * **Given** 用户在设置页，**When** 输入有效代理地址并保存，**Then** 配置生效，且后续外部API请求通过代理发出。
  * **Given** 用户输入无效代理地址，**When** 测试或保存，**Then** 系统提示连接失败。
  * **Given** 代理地址为空，**When** 系统调用外部API，**Then** 直接进行网络连接。

**用户故事 1.4: 配置Sonarr/Prowlarr连接**
* **As a** 用户, **I want to** 输入并保存我的Sonarr和Prowlarr的服务器地址与API密钥, **so that** 工具能与我现有的arr生态系统集成。
* **验收标准:**
  * **Given** 用户在设置页，**When** 输入有效的URL和API Key并测试，**Then** 系统提示“连接成功”并保存凭据。
  * **Given** 用户输入无效信息，**When** 测试，**Then** 系统提示明确的连接失败原因。

### **功能模块 2: 自动化处理引擎 (Automation Engine)**

**用户故事 2.1: (核心) 实现国漫端到端自动化匹配**
* **As a** 用户 (小张), **I want to** 让**Queqiao-arr**在我无感知的情况下自动完成“翻译”请求、搜索、解析的全过程, **so that** 我添加的国漫能被全自动下载。
* **验收标准:**
  * **Given** 所有配置正确，且在Sonarr中添加了一部国漫，**When** Sonarr触发搜索，**Then** 本工具能成功返回匹配结果，最终让Sonarr抓取到正确的下载任务，全程无需手动干预。

**用户故事 2.2: 增强搜索请求 (元数据增强)**
* **As the** 系统, **I want to** 收到Sonarr请求后查询TMDB API, **so that** 我能获取到该剧集的所有中文标题和别名用于精准搜索。
* **验收标准:**
  * **Given** 收到为“Douluo Dalu”的请求，**When** 查询TMDB，**Then** 成功获取到包含“斗罗大陆”等信息的元数据对象。
  * **Given** 查询的标题在TMDB不存在，**When** API调用失败，**Then** 记录警告日志并降级使用原始标题搜索。

**用户故事 2.3: 解析搜索结果**
* **As the** 系统, **I want to** 使用内置解析规则处理从Prowlarr返回的原始标题, **so that** 我能准确提取出季号、集号、分辨率等关键信息。
* **验收标准:**
  * **Given** 收到标题 `[VCB-Studio][斗罗大陆][156][108p]`，**When** 解析该标题，**Then** 必须成功解析出剧集名锚点、集号`156`、质量`1080p`等。
  * **Given** 收到无法解析出集号的标题，**When** 解析该标题，**Then** 该条目应被丢弃，不返回给Sonarr。

**用户故事 2.4: 标准化响应**
* **As the** 系统, **I want to** 将成功解析的结果封装成Sonarr兼容的Torznab XML格式, **so that** Sonarr可以正确识别并处理这些结果。
* **验收标准:**
  * **Given** 成功解析出N条有效结果，**When** 响应Sonarr API请求，**Then** 返回的是包含N个`<item>`条目的、格式严格有效的XML。

## 6. 非功能需求 (Non-Functional Requirements)
- **性能 (Performance):** 工具自身处理单个请求的平均耗时应在 **2秒** 以内。
- **兼容性 (Compatibility):** 需兼容 **Sonarr v3+** 和 **Prowlarr v1+**。
- **可用性 (Usability):** 新用户在 **5分钟** 内可完成所有必要配置。
- **安全性 (Security):** 所有敏感凭据（用户密码、API Key）必须加密或哈希存储。

## 7. 假设与依赖 (Assumptions & Dependencies)
- **假设:** 用户已拥有正常运行的Sonarr和Prowlarr/Jackett环境。用户网络可访问TMDB API（或已配置代理）。
- **依赖:** 强依赖Sonarr、Prowlarr/Jackett、TMDB的API稳定可用。应用部署强依赖 **Docker** 环境以简化流程。

## 8. 附录 (Appendices) - V2 未来规划
以下功能经过讨论，确认为非常有价值，但为保证MVP的专注与交付速度，将纳入V2及后续版本的开发规划中：
- **旗舰功能：媒体库状态海报墙:** 提供一个统一的Web界面，以海报墙形式展示来自Sonarr的剧集库状态，并计划集成Jellyfin的媒体库信息，方便用户统一查看。
- **手动干预系统:** 允许用户针对识别失败的剧集，手动建立永久的“别名映射”。
- **自定义解析规则:** 允许高级用户为特定命名格式编写自己的正则表达式。
- **支持更多元数据源:** 引入Bangumi等作为TMDB的补充。
- **统计仪表盘:** 在主页展示自动化成功率等指标。
