# FE-06 与 B-09 联调测试指南

## 一、前后端数据契约修复

### 1.1 已修复的问题

#### ✅ 选项数据结构对齐
- **问题**：后端返回 `{code, label}`，前端期望 `{code, name}`
- **修复**：前端类型定义和组件统一使用 `label` 字段
- **影响文件**：
  - `frontend/src/api/types.ts`
  - `frontend/src/views/config/index.vue`

#### ✅ 配置返回结构完善
- **问题**：后端 PUT 接口只返回 `{id}`，前端期望完整配置
- **修复**：后端 PUT `/api/config/tmdb` 现在返回完整的 `TmdbConfigOut` 对象
- **影响文件**：
  - `backend/app/api/endpoints/config.py`

#### ✅ ID 字段添加
- **问题**：后端 `TmdbConfigOut` 缺少 `id` 字段
- **修复**：添加 `id: Optional[int]` 字段并在返回时包含
- **影响文件**：
  - `backend/app/api/endpoints/config.py`

## 二、API 接口清单

### 2.1 GET /api/v1/config/tmdb
**功能**：读取 TMDB 配置

**请求**：
```
GET /api/v1/config/tmdb
Authorization: Bearer <token>
```

**响应**（200）：
```json
{
  "code": 200,
  "message": "OK",
  "data": {
    "id": 1,
    "service_name": "tmdb",
    "service_type": "metadata",
    "name": "默认TMDB",
    "url": "https://api.themoviedb.org/3",
    "api_key_masked": "ABCD****WXYZ",
    "extra_config": {
      "use_proxy": false,
      "language": "zh-CN",
      "region": "CN",
      "include_adult": false
    },
    "is_active": true
  }
}
```

### 2.2 PUT /api/v1/config/tmdb
**功能**：更新 TMDB 配置

**请求**：
```json
PUT /api/v1/config/tmdb
Authorization: Bearer <token>
Content-Type: application/json

{
  "api_key": "your_api_key_here",  // 可选，仅在修改时传入
  "language": "zh-CN",
  "region": "CN",
  "include_adult": false,
  "use_proxy": false
}
```

**响应**（200）：
```json
{
  "code": 200,
  "message": "OK",
  "data": {
    "id": 1,
    "service_name": "tmdb",
    "service_type": "metadata",
    "name": "默认TMDB",
    "url": "https://api.themoviedb.org/3",
    "api_key_masked": "your_****here",
    "extra_config": {
      "use_proxy": false,
      "language": "zh-CN",
      "region": "CN",
      "include_adult": false
    },
    "is_active": true
  }
}
```

### 2.3 GET /api/v1/config/tmdb/options
**功能**：获取语言和地区选项

**请求**：
```
GET /api/v1/config/tmdb/options
Authorization: Bearer <token>
```

**响应**（200）：
```json
{
  "code": 200,
  "message": "OK",
  "data": {
    "languages": [
      {"code": "zh-CN", "label": "中文（简体）"},
      {"code": "zh-TW", "label": "中文（繁體）"},
      {"code": "en-US", "label": "English (US)"}
    ],
    "regions": [
      {"code": "CN", "label": "中国大陆"},
      {"code": "HK", "label": "中国香港"},
      {"code": "TW", "label": "中国台湾"},
      {"code": "US", "label": "United States"}
    ]
  }
}
```

### 2.4 POST /api/v1/config/test-connection
**功能**：测试 TMDB 连接

**请求示例1**（by_body，直连）：
```json
POST /api/v1/config/test-connection
Authorization: Bearer <token>
Content-Type: application/json

{
  "mode": "by_body",
  "service_name": "tmdb",
  "url": "https://api.themoviedb.org",
  "api_key": "your_api_key"
}
```

**请求示例2**（by_body，使用代理）：
```json
POST /api/v1/config/test-connection
Authorization: Bearer <token>
Content-Type: application/json

{
  "mode": "by_body",
  "service_name": "tmdb",
  "url": "https://api.themoviedb.org",
  "api_key": "your_api_key",
  "proxy": {
    "http": "http://127.0.0.1:7890",
    "https": "http://127.0.0.1:7890"
  }
}
```

**请求示例3**（by_id，自动注入代理）：
```json
POST /api/v1/config/test-connection
Authorization: Bearer <token>
Content-Type: application/json

{
  "mode": "by_id",
  "id": 1
}
```

**响应**（200）：
```json
{
  "code": 200,
  "message": "OK",
  "data": {
    "ok": true,
    "latency_ms": 132,
    "details": "TMDB API 连接成功"
  }
}
```

## 三、前端测试步骤

### 3.1 启动服务

1. **启动后端**：
   ```bash
   cd backend
   ..\venv\Scripts\python.exe -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

2. **启动前端**：
   ```bash
   cd frontend
   npm run dev
   ```

3. **访问**：打开浏览器访问 http://localhost:5173

### 3.2 功能测试清单

#### ✅ 登录功能
1. 使用已注册账号登录
2. 验证 token 正常保存

#### ✅ 配置页面访问
1. 导航到"配置中心"页面
2. 验证 TMDB 卡片正常显示
3. 验证与 Sonarr/Prowlarr 卡片对齐（左侧50%宽度）

#### ✅ 选项加载
1. 页面加载时自动获取语言和地区选项
2. 验证下拉选项正常显示
3. 验证默认值：语言=zh-CN，地区=CN

#### ✅ 配置读取
1. 如果已有配置，验证：
   - API 地址正确显示（禁用状态）
   - API 密钥不回显明文，显示掩码提示
   - 语言、地区、开关正确回显
2. 如果无配置，验证：
   - 显示默认值
   - 提示"已保存的密钥不会回显明文"

#### ✅ 配置保存
1. 输入有效的 TMDB API Key
2. 选择语言和地区
3. 切换"包含成人内容"和"启用代理"开关
4. 点击"保存"按钮
5. 验证：
   - 保存成功提示
   - 掩码提示更新
   - "保存"按钮变为禁用状态（无修改）

#### ✅ 配置更新
1. 修改语言或地区
2. 不修改 API Key
3. 点击"保存"
4. 验证：
   - 保存成功
   - API Key 未被清空
   - 新配置生效

#### ✅ 连接测试（直连）
1. 确保填写了有效的 API Key
2. 确保"启用代理"关闭
3. 点击"测试连接"
4. 验证：
   - 按钮显示加载状态
   - 成功显示绿色对勾图标和成功消息
   - 失败显示红色叉号图标和错误信息

#### ✅ 连接测试（代理模式）
1. 先配置全局代理
2. 开启 TMDB 的"启用代理"开关
3. 点击"测试连接"
4. 验证：
   - 代理配置自动注入到测试请求
   - 测试成功或失败都有正确反馈

#### ✅ 表单校验
1. 清空 API Key（对于新配置）
2. 尝试保存
3. 验证：
   - 显示"API 密钥长度至少 8 字符"错误
   - "保存"和"测试连接"按钮禁用

#### ✅ 重置功能
1. 修改任意字段
2. 点击"重置"按钮
3. 验证：
   - 所有字段恢复到初始值
   - 校验错误清除

#### ✅ 敏感信息保护
1. 检查浏览器开发者工具 Network 标签
2. 查看 GET /tmdb 响应
3. 验证：
   - 返回的是 `api_key_masked`，不是明文
   - 前端不回显明文密钥

## 四、已知问题与注意事项

### 4.1 TMDB API Key 获取
- 需要在 https://www.themoviedb.org 注册账号
- 在账户设置中申请 API Key（v3）
- 用于实际连接测试

### 4.2 代理配置
- 测试代理模式前需先配置全局代理
- 代理地址格式：`http://host:port` 或 `socks5://host:port`

### 4.3 错误处理
- 401：未登录或 token 过期，需重新登录
- 400：参数错误，检查表单字段
- 408：连接超时，检查网络或代理设置
- 502/503：TMDB 上游服务异常

## 五、下一步计划

### 5.1 后续优化
- [ ] 添加更多语言和地区选项
- [ ] 支持自定义 TMDB API 版本
- [ ] 添加配置测试的详细诊断信息

### 5.2 B-09 任务完成
- [ ] 完成所有功能测试
- [ ] 更新任务文档进度
- [ ] 合并到 develop 分支

## 六、联调测试签字

- **前端开发**: ______  日期: ______
- **后端开发**: ______  日期: ______
- **测试验证**: ______  日期: ______

