### B-03｜配置加密存储与解密读取（Backend）

—— 任务文档（需求、设计、进度与验收）

---

#### 1. 背景与目标

- 依据 PRD 与技术方案，应用需对敏感配置（第三方服务 API Key、密码、代理凭据等）进行加密存储，并在必要时解密使用，前端/列表接口不应泄露明文。
- 目标：
  - 在数据库层面，仅存储密文（KV 场景由 `is_encrypted` 控制）。
  - 在 API 层面，创建/更新时对敏感字段加密，查询列表时仅返回掩码或“不可见”标识，不回显明文；仅在必要的后端内部调用时解密使用（如连通性测试）。
  - 保持现有前端交互体验（例如“保留不变”的输入框行为）并提升一致性。

#### 2. 现状评估（截至当前分支）

- 加密工具：`app/utils/encryption.py`
  - 已实现 `EncryptionManager`，使用 PBKDF2(SHA256) + 固定 salt 生成 Fernet Key，支持 `encrypt/decrypt`；默认口令来自 `settings.SECRET_KEY`。
  - 备注：salt 固定为 `b"queqiao-arr-salt"`，生产建议随机化并外部化（见“安全与密钥管理”）。

- 数据模型：`app/models/config.py`
  - `ServiceConfig.api_key/password` 字段类型为 `Text`，用于存储密文。
  - `Configuration`（KV）含 `is_encrypted` 标记，用于区分是否以密文存储。

- CRUD：`app/db/crud_config.py`
  - 常规 CRUD 已具备；未在 CRUD 层做加/解密（由 API 层负责）。

- 配置端点：`app/api/endpoints/config.py`
  - 创建/更新：
    - ServiceConfig 的 `api_key/password` 会加密入库。
    - KV 在 `is_encrypted=True` 且提供值时进行加密入库。
  - 查询列表：
    - ServiceConfig：会先解密 `api_key`，再返回掩码字符串（前后各 4 位，其他为 `*`）。
    - KV：直接返回 `value` 当前存储值（若是密文，则返回密文本身）。这对前端体验不佳，也可能引起混淆。
  - 连通性测试：
    - `by_id` 模式下，会对存储的密文进行解密再调用客户端层测试。

结论：
1) ServiceConfig 流程基本符合要求（加密入库、列表返回掩码、按需解密）。
2) KV 在查询列表场景下应避免返回密文本身，建议返回“不可见/掩码/存在标记”，以与 ServiceConfig 行为一致。

#### 3. 需求与验收标准（Acceptance Criteria）

- 必须：敏感字段仅以密文形式存于数据库；除专门用途（例如连接测试）外，API 不返回明文。
- 列表/概览接口：
  - ServiceConfig：继续返回 `api_key_masked`，不返回明文。
  - KV：当 `is_encrypted=True` 时，不返回密文原文；返回 `value_masked` 或 `has_value` 标记，且不包含可还原的明文信息。
- 创建/更新：
  - 提交敏感字段时加密入库；
  - 不提交（空/缺省）时视为“保持不变”。
- 内部使用：
  - 仅在后端内部动作（如 `test-connection`）中解密并使用。
- 兼容与迁移：
  - 若已存在历史数据（可能是明文/密文混杂），需给出明确的迁移策略或惰性处理策略，避免服务中断。
- 安全：
  - 不在日志中输出明文；
  - 解密失败要有明确错误说明且不泄露密钥材料。

#### 4. 设计方案

4.1 数据与接口行为

- ServiceConfig：
  - 存储：`api_key/password` 永远密文。
  - 查询（列表/概览）：仅返回 `api_key_masked`，不返回 `api_key` 明文或密文；`password` 不对外回显。
  - 更新：若字段缺省则保持不变；若提供空字符串则置空（并存储为 `NULL`）。

- Configuration（KV）：
  - 存储：当 `is_encrypted=True` 时，`value` 以密文保存；否则明文保存。
- 查询（列表/概览）：
    - 若 `is_encrypted=True`：不返回密文内容本身，固定采用 `has_value: true|false`（仅表明是否已设置），并令 `value` 为空。
    - 若 `is_encrypted=False`：继续返回明文 `value`。
  - 更新：
    - 支持切换 `is_encrypted` 标记。若提交了新 `value`，按当前目标加密策略存储；若未提交 `value`，仅切换标记不改变存量数据（与现有实现一致）。

4.2 安全与密钥管理

- 口令来源：`settings.SECRET_KEY`（来自环境变量或 `.env`）。
- 派生策略：PBKDF2(SHA256) + salt -> Fernet Key。
- 现状 salt 固定，MVP 阶段保留现状；文档化风险与改进方向：
  - 后续版本将支持：
    - salt 外部化（环境变量/独立文件/密钥管理服务）；
    - salt 轮换与数据再加密（提供离线迁移脚本）。
- 日志：绝不输出明文或密钥材料；错误信息做通用化处理。

4.3 迁移策略

- 场景 A：历史 KV `is_encrypted=True` 但 `value` 存明文。
  - 惰性修复：在下次更新该 Key 时对新值执行加密；
  - 或提供一次性维护脚本（低优先）扫描并加密不合规条目。

- 场景 B：历史 ServiceConfig `api_key/password` 为明文。
  - 理论上不应存在（当前创建/更新路径都会加密）。若存在，可在“编辑并保存”时完成加密归档。

4.4 失败与异常处理

- 解密失败：抛出通用的 400/422 级别错误信息（不泄露内部细节），引导用户检查 `SECRET_KEY` 或数据完整性。
- 连接测试：保持当前 try/catch 语义，返回结构化失败详情。

4.5 测试用例（建议）

- 单元测试：
  - `EncryptionManager`：同口令加解密/不同口令解密失败/空值透传/异常处理。
  - KV：`is_encrypted=True`/False 下创建、更新、查询行为；掩码/不可见策略校验。
  - ServiceConfig：创建/更新加密；查询仅返回掩码；`by_id` 连接测试能正确解密使用。

- 集成测试：
  - 以接口为入口验证端到端流程（创建→列表→更新→测试连接）。

#### 5. 接口契约（草案，变更点）

- GET `/api/config/` 响应中的 `kv` 项：
  - 当 `is_encrypted=True` 时，不返回密文字符串；固定新增 `has_value: true|false`，并令 `value` 为空。

- POST/PUT `/api/config/`：
  - 保持现有请求体；敏感字段在服务端加密后入库；
  - 未提供字段表示“保持不变”，提供空字符串表示清空。

#### 6. 风险与规避

- 固定 salt 带来的离线攻击面：MVP 保守保留，短期通过足够强的 `SECRET_KEY` 与 PBKDF2 迭代降低风险；中期计划支持 salt 外部化与轮换。
- 前端交互一致性：KV 的“不可见/掩码”策略需前端适配；以“保留不变”作为默认行为，避免误清空。
- 历史数据不合规：优先采用惰性修复，避免一次性迁移影响可用性。

#### 7. 实施清单与进度

- [x] 现状调研（工具、模型、端点、流程）
- [x] KV 列表返回策略确定（采用 has_value）
- [ ] 后端接口调整与单测补齐（不在本次文档提交流程中提交代码）
- [ ] 前端适配（显示“已设置/未设置”或固定掩码）
- [ ] 端到端联调与用例覆盖

#### 8. 验收标准（Done Definition）

- 数据库存储符合策略：ServiceConfig 敏感字段恒为密文；KV 在 `is_encrypted=True` 时恒为密文。
- 列表接口不返回可还原的敏感明文或密文原文；ServiceConfig 提供掩码；KV 提供 `has_value` 存在标记。
- 连接测试等内部流程可正确解密并执行。
- 单元测试与集成测试覆盖上述核心路径并通过。

#### 9. 关联资料

- PRD：《docs/需求文档.md》
- 技术方案：《docs/Queqiao-arr 技术方案与开发计划书.md》
- 相关代码：
  - `app/utils/encryption.py`
  - `app/models/config.py`
  - `app/db/crud_config.py`
  - `app/api/endpoints/config.py`


