# B-10: 外部服务客户端层（Sonarr / Prowlarr / TMDB）任务说明书

## 一、任务信息
- 任务ID: B-10
- 名称: 外部服务客户端层（统一封装 + 工厂）
- 复杂度: M（约 3 PD）
- 优先级: P0
- 依赖: F-01（项目结构）
- 被依赖: B-02（配置模块API 测试连接）、B-04（TMDB 客户端使用）、B-05（Prowlarr 搜索）
- **状态**: ✅ 已完成
- **完成日期**: 2025-10-16
- **提交**: `f73f34f` (feature/B-10-external-clients-layer)

---

## 二、目标与范围（Scope）
- 目标：抽离并统一管理外部 API（Sonarr / Prowlarr / TMDB）访问逻辑，提供可靠、可测试、可扩展的客户端层。
- 范围：
  - 创建 `app/services/clients/` 目录与基础类 `base.py`
  - 实现 `SonarrClient`、`ProwlarrClient`、`TMDBClient` 最小能力（状态检查或基础请求）
  - 提供 `factory.py` 根据 `service_name` 构建对应客户端
  - 支持：统一超时、代理、Header（`X-Api-Key` 等），错误返回规范化
- 非范围：
  - 复杂的业务编排逻辑（由 B-08 / 核心引擎承担）
  - 全量 TMDB / Prowlarr API 封装（按需增量）

---

## 三、设计与目录结构
```
backend/app/services/clients/
  base.py        # ExternalServiceClient：统一超时、代理、Headers
  sonarr.py      # SonarrClient：/api/v3/system/status
  prowlarr.py    # ProwlarrClient：/api/v1/system/status
  tmdb.py        # TMDBClient：最小查询能力（预留）
  factory.py     # make_client(service_name, url, api_key, proxies)
```

### 3.1 Base 基类
- 属性：`base_url`、`api_key`、`proxies`、`timeout`
- 方法：`_get(path, headers=None)`、后续可扩展 `_post` 等
- 统一异常处理：转换为标准错误消息（保留 HTTP 状态码）

### 3.2 Sonarr / Prowlarr 客户端
- `check_status()`：
  - Sonarr：`GET /api/v3/system/status`
  - Prowlarr：`GET /api/v1/system/status`
  - 返回 `(ok: bool, note: str)`

### 3.3 TMDB 客户端（占位）
- 预留 `search_tv()`/`get_alternative_titles()` 等方法签名；当前可仅返回 `NotImplementedError` 或最小路径

### 3.4 工厂
- `make_client(service_name, url, api_key, proxies)`：返回具体客户端实例；未知服务抛出 `ValueError`

---

## 四、与现有模块的衔接
- B-02 中 `test-connection` 将调用工厂生成的客户端并执行 `check_status()`，替换当前写死路径的实现
- 后续 B-04 / B-05 直接使用对应客户端，避免重复请求代码

---

## 五、验收标准（Acceptance Criteria）
1. `services/clients` 目录与基类/子类/工厂落地，接口清晰
2. Sonarr/Prowlarr 的 `check_status()` 正确（v3/v1 版本路径分别可用）
3. 支持代理、超时与 `X-Api-Key` Header；异常能返回可读信息
4. B-02 中 `test-connection` 成功切换为客户端层调用，功能等价
5. 基础单测：对 `check_status` 成功/失败路径做最小覆盖

---

## 六、实施计划（3 PD）
- Day 1：落地目录结构与 Base；实现 Sonarr/Prowlarr 客户端；工厂完成
- Day 2：接入 B-02 `test-connection`；补齐代理/超时与错误处理
- Day 3：补充最小单测与文档；代码走查

---

## 七、风险与对策
- 版本差异：不同版本 API 路径差异 → 客户端中就地适配并单测
- 代理兼容性：环境差异导致代理不可用 → 增加可配置超时与错误信息透传
- 扩展性：后续能力增长 → 通过基类与工厂保持开放封闭

---

## 八、参考
- Sonarr API：/api/v3/system/status
- Prowlarr API：/api/v1/system/status
- 现有实现：`backend/app/api/endpoints/config.py`（已被替换为客户端调用）

---

## 九、实施总结

### 9.1 完成情况
✅ **所有验收标准已达成**

1. ✅ 创建了完整的 `services/clients` 目录结构，包含基类、子类和工厂
2. ✅ Sonarr/Prowlarr 客户端的 `check_status()` 方法正确实现（分别使用 v3/v1 API）
3. ✅ 完整支持代理、超时、`X-Api-Key` Header，异常处理规范且信息清晰
4. ✅ B-02 的 `test-connection` 端点成功切换为客户端层调用
5. ✅ 编写了 18 个单元测试，覆盖成功/失败/异常等多种场景

### 9.2 交付内容

**新增文件**:
- `backend/app/services/__init__.py` - 服务层入口
- `backend/app/services/clients/__init__.py` - 客户端层导出
- `backend/app/services/clients/base.py` - 基础客户端类（184 行）
- `backend/app/services/clients/sonarr.py` - Sonarr 客户端（49 行）
- `backend/app/services/clients/prowlarr.py` - Prowlarr 客户端（49 行）
- `backend/app/services/clients/tmdb.py` - TMDB 客户端（119 行）
- `backend/app/services/clients/factory.py` - 客户端工厂（56 行）
- `backend/tests/test_clients.py` - 客户端层单元测试（282 行，18 个测试用例）

**修改文件**:
- `backend/app/api/endpoints/config.py` - 重构 `test_service_connection` 使用客户端层
- `backend/tests/test_config.py` - 修复测试以适配新实现

**代码统计**:
- 新增代码: 800+ 行
- 删除代码: 49 行
- 测试通过率: 100% (22/22 测试全部通过)

### 9.3 技术亮点

1. **统一的基础设施**: `ExternalServiceClient` 基类提供了统一的 HTTP 请求封装、超时管理、代理支持和错误处理
2. **工厂模式**: 通过 `make_client()` 函数实现灵活的客户端创建，支持参数验证
3. **TMDB 特殊处理**: 正确处理 TMDB API Key 通过查询参数传递的特性
4. **完善的测试**: 包含工厂测试、各客户端的成功/失败路径测试、基类功能测试等
5. **向后兼容**: 重构后的 `test-connection` 功能完全等价于原实现

### 9.4 后续建议

1. B-04 任务中可直接使用 `TMDBClient` 实现 TMDB API 调用
2. B-05 任务中可直接使用 `ProwlarrClient` 实现搜索功能
3. 如需扩展其他外部服务，可按照相同模式添加新的客户端类
