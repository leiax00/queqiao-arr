# B-10: 外部服务客户端层（Sonarr / Prowlarr / TMDB）任务说明书

## 一、任务信息
- 任务ID: B-10
- 名称: 外部服务客户端层（统一封装 + 工厂）
- 复杂度: M（约 3 PD）
- 优先级: P0
- 依赖: F-01（项目结构）
- 被依赖: B-02（配置模块API 测试连接）、B-04（TMDB 客户端使用）、B-05（Prowlarr 搜索）

---

## 二、目标与范围（Scope）
- 目标：抽离并统一管理外部 API（Sonarr / Prowlarr / TMDB）访问逻辑，提供可靠、可测试、可扩展的客户端层。
- 范围：
  - 创建 `app/services/clients/` 目录与基础类 `base.py`
  - 实现 `SonarrClient`、`ProwlarrClient`、`TMDBClient` 最小能力（状态检查或基础请求）
  - 提供 `factory.py` 根据 `service_name` 构建对应客户端
  - 支持：统一超时、代理、Header（`X-Api-Key` 等），错误返回规范化
- 非范围：
  - 复杂的业务编排逻辑（由 B-08 / 核心引擎承担）
  - 全量 TMDB / Prowlarr API 封装（按需增量）

---

## 三、设计与目录结构
```
backend/app/services/clients/
  base.py        # ExternalServiceClient：统一超时、代理、Headers
  sonarr.py      # SonarrClient：/api/v3/system/status
  prowlarr.py    # ProwlarrClient：/api/v1/system/status
  tmdb.py        # TMDBClient：最小查询能力（预留）
  factory.py     # make_client(service_name, url, api_key, proxies)
```

### 3.1 Base 基类
- 属性：`base_url`、`api_key`、`proxies`、`timeout`
- 方法：`_get(path, headers=None)`、后续可扩展 `_post` 等
- 统一异常处理：转换为标准错误消息（保留 HTTP 状态码）

### 3.2 Sonarr / Prowlarr 客户端
- `check_status()`：
  - Sonarr：`GET /api/v3/system/status`
  - Prowlarr：`GET /api/v1/system/status`
  - 返回 `(ok: bool, note: str)`

### 3.3 TMDB 客户端（占位）
- 预留 `search_tv()`/`get_alternative_titles()` 等方法签名；当前可仅返回 `NotImplementedError` 或最小路径

### 3.4 工厂
- `make_client(service_name, url, api_key, proxies)`：返回具体客户端实例；未知服务抛出 `ValueError`

---

## 四、与现有模块的衔接
- B-02 中 `test-connection` 将调用工厂生成的客户端并执行 `check_status()`，替换当前写死路径的实现
- 后续 B-04 / B-05 直接使用对应客户端，避免重复请求代码

---

## 五、验收标准（Acceptance Criteria）
1. `services/clients` 目录与基类/子类/工厂落地，接口清晰
2. Sonarr/Prowlarr 的 `check_status()` 正确（v3/v1 版本路径分别可用）
3. 支持代理、超时与 `X-Api-Key` Header；异常能返回可读信息
4. B-02 中 `test-connection` 成功切换为客户端层调用，功能等价
5. 基础单测：对 `check_status` 成功/失败路径做最小覆盖

---

## 六、实施计划（3 PD）
- Day 1：落地目录结构与 Base；实现 Sonarr/Prowlarr 客户端；工厂完成
- Day 2：接入 B-02 `test-connection`；补齐代理/超时与错误处理
- Day 3：补充最小单测与文档；代码走查

---

## 七、风险与对策
- 版本差异：不同版本 API 路径差异 → 客户端中就地适配并单测
- 代理兼容性：环境差异导致代理不可用 → 增加可配置超时与错误信息透传
- 扩展性：后续能力增长 → 通过基类与工厂保持开放封闭

---

## 八、参考
- Sonarr API：/api/v3/system/status
- Prowlarr API：/api/v1/system/status
- 现有实现：`backend/app/api/endpoints/config.py`（将被替换为客户端调用）
