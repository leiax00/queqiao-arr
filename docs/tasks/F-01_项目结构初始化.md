# **F-01: 项目结构初始化开发任务说明书**

## **任务基本信息**

| 项目 | Queqiao-arr |
|------|-------------|
| **任务ID** | F-01 |
| **任务名称** | 初始化项目结构（后端FastAPI + 前端Vue），配置Git仓库 |
| **复杂度** | S (Simple) |
| **估算工期** | 2 人日 (Person-Day) |
| **优先级** | P0 (最高) |
| **依赖任务** | 无 |
| **后续任务** | F-02, B-01, FE-01 |

## **任务目标**

建立完整的项目骨架结构，包含后端FastAPI框架和前端Vue 3 + TypeScript框架，配置开发环境和基础工具链，为后续开发工作奠定坚实基础。

## **详细需求说明**

### **1. 项目根目录结构设计**

创建如下标准化的项目目录结构：

```
queqiao-arr/
├── README.md                    # 项目说明文档
├── .gitignore                   # Git忽略文件配置
├── .env.example                 # 环境变量模板文件
├── docker-compose.yml           # Docker编排配置
├── Dockerfile                   # 容器构建文件
├── docs/                        # 项目文档目录
│   ├── api/                     # API文档
│   ├── deployment/              # 部署文档
│   └── development/             # 开发文档
├── backend/                     # 后端代码目录
│   ├── app/                     # 应用主代码
│   │   ├── __init__.py
│   │   ├── main.py              # FastAPI应用入口
│   │   ├── config/              # 配置模块
│   │   ├── models/              # 数据模型
│   │   ├── api/                 # API路由
│   │   ├── core/                # 核心业务逻辑
│   │   ├── db/                  # 数据库相关
│   │   ├── utils/               # 工具函数
│   │   └── tests/               # 测试代码
│   ├── requirements.txt         # Python依赖
│   ├── pyproject.toml          # Python项目配置
│   └── alembic/                # 数据库迁移
└── frontend/                   # 前端代码目录
    ├── src/                    # 源代码
    │   ├── main.ts             # 应用入口
    │   ├── App.vue             # 根组件
    │   ├── components/         # 组件目录
    │   ├── views/              # 页面组件
    │   ├── router/             # 路由配置
    │   ├── stores/             # 状态管理
    │   ├── utils/              # 工具函数
    │   ├── types/              # TypeScript类型定义
    │   └── assets/             # 静态资源
    ├── public/                 # 公共资源
    ├── package.json            # 项目依赖配置
    ├── vite.config.ts          # Vite构建配置
    ├── tsconfig.json           # TypeScript配置
    ├── tailwind.config.js      # Tailwind CSS配置
    └── index.html              # HTML模板
```

### **2. 后端FastAPI框架初始化**

#### **2.1 核心依赖包选择**

在 `backend/requirements.txt` 中配置以下依赖：

```txt
# Web框架
fastapi==0.104.1
uvicorn[standard]==0.24.0

# 数据库
sqlalchemy==2.0.23
alembic==1.12.1
aiosqlite==0.19.0

# 认证与安全
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6

# HTTP客户端
httpx==0.25.2
aiofiles==23.2.1

# 配置管理
python-dotenv==1.0.0
pydantic-settings==2.0.3

# 开发工具
pytest==7.4.3
pytest-asyncio==0.21.1
black==23.11.0
ruff==0.1.6
mypy==1.7.1

# 日志
loguru==0.7.2

# XML处理
lxml==4.9.3
xmltodict==0.13.0
```

#### **2.2 FastAPI应用基础结构**

创建 `backend/app/main.py` 作为应用入口：

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from contextlib import asynccontextmanager

from app.core.config import settings
from app.api.routes import api_router
from app.db.database import create_tables

@asynccontextmanager
async def lifespan(app: FastAPI):
    # 启动时执行
    await create_tables()
    yield
    # 关闭时执行

app = FastAPI(
    title="Queqiao-arr",
    description="中文内容自动化下载代理服务",
    version="1.0.0",
    lifespan=lifespan
)

# CORS配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.ALLOWED_HOSTS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# API路由
app.include_router(api_router, prefix="/api/v1")

# 静态文件服务（生产环境用于服务前端）
app.mount("/", StaticFiles(directory="static", html=True), name="static")

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True
    )
```

#### **2.3 配置管理系统**

创建 `backend/app/core/config.py`：

```python
from pydantic_settings import BaseSettings
from typing import List

class Settings(BaseSettings):
    # 应用配置
    APP_NAME: str = "Queqiao-arr"
    DEBUG: bool = False
    
    # 数据库配置
    DATABASE_URL: str = "sqlite+aiosqlite:///./queqiao.db"
    
    # 安全配置
    SECRET_KEY: str = "your-secret-key-change-in-production"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    
    # CORS配置
    ALLOWED_HOSTS: List[str] = ["*"]
    
    # 外部API配置
    TMDB_API_KEY: str = ""
    TMDB_BASE_URL: str = "https://api.themoviedb.org/3"
    
    # 代理配置
    HTTP_PROXY: str = ""
    HTTPS_PROXY: str = ""
    
    class Config:
        env_file = ".env"
        case_sensitive = True

settings = Settings()
```

### **3. 前端Vue 3 + TypeScript框架初始化**

#### **3.1 核心依赖包配置**

在 `frontend/package.json` 中配置：

```json
{
  "name": "queqiao-arr-frontend",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix --ignore-path .gitignore",
    "type-check": "vue-tsc --noEmit"
  },
  "dependencies": {
    "vue": "^3.3.8",
    "vue-router": "^4.2.5",
    "pinia": "^2.1.7",
    "element-plus": "^2.4.4",
    "axios": "^1.6.2",
    "@element-plus/icons-vue": "^2.1.0"
  },
  "devDependencies": {
    "@types/node": "^20.9.0",
    "@vitejs/plugin-vue": "^4.5.0",
    "@vue/eslint-config-prettier": "^8.0.0",
    "@vue/eslint-config-typescript": "^12.0.0",
    "@vue/tsconfig": "^0.4.0",
    "eslint": "^8.54.0",
    "eslint-plugin-vue": "^9.18.1",
    "prettier": "^3.1.0",
    "typescript": "~5.2.2",
    "vite": "^5.0.0",
    "vue-tsc": "^1.8.22"
  }
}
```

#### **3.2 Vite构建配置**

创建 `frontend/vite.config.ts`：

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
    },
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      },
    },
  },
  build: {
    outDir: '../backend/static',
    emptyOutDir: true,
  },
})
```

#### **3.3 TypeScript配置**

创建 `frontend/tsconfig.json`：

```json
{
  "extends": "@vue/tsconfig/tsconfig.dom.json",
  "include": ["env.d.ts", "src/**/*", "src/**/*.vue"],
  "compilerOptions": {
    "composite": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}
```

### **4. 开发工具配置**

#### **4.1 Git配置**

##### **4.1.1 Git提交信息规范 (Conventional Commits)**

采用 [Conventional Commits](https://www.conventionalcommits.org/) 规范，确保提交历史清晰可读：

**提交信息格式：**
```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

**Type类型定义：**
- `feat`: 新功能 (feature)
- `fix`: 修复bug
- `docs`: 仅文档更改
- `style`: 不影响代码含义的更改（空格、格式化、缺少分号等）
- `refactor`: 既不修复错误也不添加功能的代码更改
- `perf`: 改善性能的代码更改
- `test`: 添加缺失的测试或纠正现有测试
- `build`: 影响构建系统或外部依赖的更改（示例范围：gulp、broccoli、npm）
- `ci`: 对CI配置文件和脚本的更改（示例范围：Travis、Circle、BrowserStack、SauceLabs）
- `chore`: 其他不修改src或测试文件的更改
- `revert`: 撤销之前的提交

**Scope范围定义（可选）：**
- `backend`: 后端相关
- `frontend`: 前端相关
- `api`: API相关
- `db`: 数据库相关
- `docker`: Docker相关
- `docs`: 文档相关
- `config`: 配置相关

**提交示例：**
```bash
feat(backend): 实现用户认证JWT令牌生成
fix(frontend): 修复登录页面表单验证错误
docs: 更新README.md部署说明
style(backend): 统一代码格式化
refactor(api): 重构配置模块API结构
test(backend): 添加用户认证模块单元测试
build(docker): 优化Dockerfile构建层缓存
ci: 添加GitHub Actions自动化测试流水线
```

##### **4.1.2 分支命名规范**

**主要分支：**
- `main`: 主分支，保持稳定可发布状态
- `develop`: 开发分支，集成最新开发功能

**功能分支命名：**
```
feature/<task-id>-<brief-description>
```

**修复分支命名：**
```
fix/<issue-id>-<brief-description>
hotfix/<critical-issue-description>
```

**发布分支命名：**
```
release/v<version-number>
```

**分支命名示例：**
```bash
feature/F-01-project-structure-init
feature/B-01-user-authentication-api
fix/FE-03-login-form-validation
hotfix/critical-security-patch
release/v1.0.0
```

##### **4.1.3 .gitignore 配置**

创建 `.gitignore` 文件：

```gitignore
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# 虚拟环境
.env
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# IDE
.vscode/
.idea/
*.swp
*.swo

# 数据库
*.db
*.sqlite
*.sqlite3

# 日志
*.log
logs/

# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# 构建输出
dist/
.tmp/
.nuxt/
.next/
.out/
.rpt2_cache/
.netlify/

# 操作系统
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# 临时文件
*.tmp
*.temp
```

##### **4.1.4 Git提交钩子配置文件**

创建 `package.json`（项目根目录，用于Git钩子管理）：

```json
{
  "name": "queqiao-arr",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "prepare": "husky install",
    "commit": "git-cz",
    "lint:commit": "commitlint --edit"
  },
  "devDependencies": {
    "@commitlint/cli": "^18.4.3",
    "@commitlint/config-conventional": "^18.4.3",
    "commitizen": "^4.3.0",
    "cz-conventional-changelog": "^3.3.0",
    "husky": "^8.0.3",
    "lint-staged": "^15.1.0"
  },
  "config": {
    "commitizen": {
      "path": "./node_modules/cz-conventional-changelog"
    }
  }
}
```

创建 `.commitlintrc.js`：

```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'feat',
        'fix',
        'docs',
        'style',
        'refactor',
        'perf',
        'test',
        'build',
        'ci',
        'chore',
        'revert'
      ]
    ],
    'scope-enum': [
      2,
      'always',
      [
        'backend',
        'frontend',
        'api',
        'db',
        'docker',
        'docs',
        'config'
      ]
    ],
    'subject-max-length': [2, 'always', 72],
    'subject-case': [2, 'never', ['pascal-case', 'upper-case']],
    'header-max-length': [2, 'always', 100]
  }
};
```

创建 `.husky/pre-commit`：

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npx lint-staged
```

创建 `.husky/commit-msg`：

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npx --no-install commitlint --edit "$1"
```

创建 `.lintstagedrc.js`：

```javascript
module.exports = {
  'backend/**/*.py': [
    'black --check',
    'ruff check',
    'mypy'
  ],
  'frontend/**/*.{js,ts,vue}': [
    'eslint --fix',
    'vue-tsc --noEmit'
  ],
  '*.md': [
    'prettier --write'
  ]
};
```

#### **4.2 环境变量模板**

创建 `.env.example`：

```bash
# 应用配置
DEBUG=true
SECRET_KEY=your-super-secret-key-change-in-production

# 数据库配置
DATABASE_URL=sqlite+aiosqlite:///./queqiao.db

# TMDB API配置
TMDB_API_KEY=your-tmdb-api-key

# 代理配置（可选）
HTTP_PROXY=
HTTPS_PROXY=

# CORS配置
ALLOWED_HOSTS=["http://localhost:3000", "http://127.0.0.1:3000"]
```

### **5. Docker配置**

#### **5.1 Dockerfile**

```dockerfile
# 多阶段构建
FROM node:18-alpine as frontend-builder

WORKDIR /app/frontend

# 配置npm国内镜像源（加速国内构建）
RUN npm config set registry https://registry.npmmirror.com

COPY frontend/package*.json ./
RUN npm ci --only=production

COPY frontend/ .
RUN npm run build

# Python后端
FROM python:3.11-slim

WORKDIR /app

# 配置apt国内镜像源（加速国内构建）
RUN sed -i 's|deb.debian.org|mirrors.aliyun.com|g' /etc/apt/sources.list.d/debian.sources \
    && sed -i 's|security.debian.org|mirrors.aliyun.com|g' /etc/apt/sources.list.d/debian.sources

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 配置pip国内镜像源并升级pip
RUN pip install --upgrade pip -i https://mirrors.aliyun.com/pypi/simple/ \
    && pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/ \
    && pip config set global.trusted-host mirrors.aliyun.com

# 复制Python依赖并安装
COPY backend/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制后端代码
COPY backend/ .

# 复制前端构建结果
COPY --from=frontend-builder /app/backend/static ./static

# 创建非root用户
RUN useradd --create-home --shell /bin/bash app \
    && chown -R app:app /app
USER app

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**国内镜像源优化说明：**

1. **Node.js构建阶段优化**：
   - 使用淘宝npm镜像源：`https://registry.npmmirror.com`
   - 大幅提升依赖包下载速度

2. **Python构建阶段优化**：
   - **apt镜像源**：替换为阿里云镜像源，解决系统包安装慢的问题
   - **pip镜像源**：使用阿里云PyPI镜像，并设置为全局默认源
   - 添加trusted-host配置，避免SSL验证问题

3. **额外优化**：
   - 添加curl工具，用于健康检查
   - 升级pip到最新版本，提升安装稳定性

#### **5.2 Docker Compose配置**

创建 `docker-compose.yml`：

```yaml
name: "queqiao-arr"

services:
  queqiao-arr:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DEBUG=false
      - DATABASE_URL=sqlite+aiosqlite:///./data/queqiao.db
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 开发环境配置
  dev:
    profiles: ["dev"]
    build:
      context: .
      target: development
    ports:
      - "8000:8000"
      - "3000:3000"
    environment:
      - DEBUG=true
    volumes:
      - .:/app
      - /app/node_modules
      - /app/backend/__pycache__
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

## **验收标准**

### **功能验收标准**

- [ ] **项目结构完整性**
  - [ ] 所有目录按照设计创建完成
  - [ ] 后端FastAPI项目可以正常启动（`uvicorn app.main:app --reload`）
  - [ ] 前端Vue项目可以正常启动（`npm run dev`）
  - [ ] 访问 http://localhost:8000 返回FastAPI默认页面
  - [ ] 访问 http://localhost:3000 返回Vue应用页面

- [ ] **配置文件完整性**
  - [ ] `.env.example` 包含所有必要的环境变量
  - [ ] `.gitignore` 正确配置，不会提交敏感文件
  - [ ] Git提交信息规范文档完整
  - [ ] commitlint配置正确，能够验证提交信息格式
  - [ ] husky预提交钩子正常工作
  - [ ] `requirements.txt` 包含所有后端依赖
  - [ ] `package.json` 包含所有前端依赖

- [ ] **Docker环境验收**
  - [ ] `docker-compose up` 可以成功构建并启动服务
  - [ ] 容器内应用可以正常访问
  - [ ] 健康检查通过

### **代码质量标准**

- [ ] **后端代码质量**
  - [ ] 通过 `black` 代码格式化检查
  - [ ] 通过 `ruff` 代码检查无错误
  - [ ] 通过 `mypy` 类型检查

- [ ] **前端代码质量**
  - [ ] 通过 `vue-tsc` 类型检查
  - [ ] 通过 `eslint` 代码检查
  - [ ] 代码遵循Vue 3 Composition API最佳实践

### **文档完整性**

- [ ] **README.md** 包含以下内容：
  - [ ] 项目介绍和功能说明
  - [ ] 快速开始指南
  - [ ] 开发环境搭建步骤
  - [ ] Docker部署说明
  - [ ] API文档链接
  - [ ] 贡献指南

## **实施步骤**

### **第一阶段：环境准备（0.5 PD）**

1. **创建项目根目录结构**
   - 按照设计创建所有必要的目录
   - 创建基础的配置文件模板

2. **Git仓库初始化与规范配置**
   - 初始化Git仓库
   - 配置 `.gitignore` 文件
   - 设置Git提交信息规范和分支命名规范
   - 配置commitlint和husky预提交钩子
   - 创建符合规范的初始提交

3. **配置国内开发环境镜像源（可选，国内开发者推荐）**
   ```bash
   # 配置npm镜像源
   npm config set registry https://registry.npmmirror.com
   
   # 配置pip镜像源
   pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/
   pip config set global.trusted-host mirrors.aliyun.com
   
   # 或者创建 ~/.pip/pip.conf 文件
   mkdir -p ~/.pip
   cat > ~/.pip/pip.conf << EOF
   [global]
   index-url = https://mirrors.aliyun.com/pypi/simple/
   trusted-host = mirrors.aliyun.com
   EOF
   ```

### **第二阶段：后端框架搭建（0.75 PD）**

1. **Python环境配置**
   - 创建虚拟环境
   - 安装基础依赖包
   - 配置 `requirements.txt`

2. **FastAPI应用初始化**
   - 创建应用入口文件 `main.py`
   - 配置基础路由结构
   - 实现配置管理系统
   - 添加CORS中间件

3. **开发工具配置**
   - 配置代码格式化工具（Black, Ruff）
   - 配置类型检查（MyPy）
   - 创建基础测试框架

### **第三阶段：前端框架搭建（0.75 PD）**

1. **Vue项目初始化**
   - 使用Vite创建Vue 3 + TypeScript项目
   - 安装Element Plus UI库
   - 配置路由系统（Vue Router）
   - 配置状态管理（Pinia）

2. **开发环境配置**
   - 配置Vite开发服务器
   - 设置代理转发到后端API
   - 配置TypeScript和ESLint
   - 创建基础组件结构

3. **构建配置**
   - 配置生产环境构建
   - 设置输出目录到后端静态文件夹

### **第四阶段：Docker化和集成测试（0.25 PD）**

1. **Docker配置**
   - 编写多阶段Dockerfile
   - 配置docker-compose.yml
   - 测试容器构建和运行

2. **集成测试**
   - 验证前后端联调
   - 测试Docker环境部署
   - 确认所有配置正确

3. **文档编写**
   - 完善README.md
   - 编写开发环境搭建指南
   - 创建基础API文档

## **风险识别与应对**

### **技术风险**

| 风险项 | 风险等级 | 影响 | 应对策略 |
|--------|----------|------|----------|
| Python依赖包版本冲突 | 低 | 开发环境问题 | 使用虚拟环境隔离，固定版本号 |
| Node.js依赖安装失败 | 低 | 前端构建失败 | 使用npm ci，配置镜像源 |
| Docker构建失败 | 中 | 部署问题 | 分阶段测试，准备基础镜像 |
| 跨平台兼容性问题 | 中 | 开发体验 | 使用Docker统一环境 |

### **进度风险**

| 风险项 | 风险等级 | 影响 | 应对策略 |
|--------|----------|------|----------|
| 配置复杂度超预期 | 低 | 进度延迟 | 使用成熟的脚手架工具 |
| 学习曲线陡峭 | 中 | 开发效率 | 提前准备技术文档和示例 |

## **交付物清单**

### **代码交付物**
- [ ] 完整的项目目录结构
- [ ] 可运行的FastAPI后端应用
- [ ] 可运行的Vue 3前端应用
- [ ] Docker容器化配置
- [ ] 开发工具配置文件

### **文档交付物**
- [ ] 项目README.md
- [ ] 环境变量配置模板
- [ ] 开发环境搭建指南
- [ ] Docker部署说明

### **配置交付物**
- [ ] Git仓库配置
- [ ] Git提交信息规范和分支命名规范
- [ ] commitlint和husky预提交钩子配置
- [ ] CI/CD基础配置文件
- [ ] 代码质量检查配置
- [ ] 依赖管理配置

## **后续任务接口**

完成F-01后，可以并行启动以下任务：

- **F-02**: Docker开发环境优化
- **B-01**: 用户认证模块开发
- **FE-01**: 前端基础组件开发

确保为后续任务提供：
- 稳定的开发环境
- 清晰的代码结构
- 完善的配置管理
- 标准化的开发流程

---

**任务负责人**: [待分配]  
**评审人**: [待分配]  
**创建日期**: 2025-09-16  
**预期完成日期**: [开始日期 + 2 PD]
