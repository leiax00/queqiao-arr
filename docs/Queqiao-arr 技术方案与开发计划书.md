# **《Queqiao-arr 技术方案与开发计划书》**

### **版本 v1.0**

## 1\. 项目概述与技术评估

### 1.1. 项目核心目标与范围

本项目旨在开发一款名为 **Queqiao-arr** 的中间代理服务。其核心目标是解决Sonarr等工具在处理中文内容（特别是国漫）时，因元数据和命名习惯差异导致的自动化下载失败问题。服务通过拦截Sonarr的搜索请求，利用TMDB等对中文友好的数据源进行“翻译”和“增强”，再向Prowlarr发起精确搜索，最后解析中文发布资源并以Sonarr兼容的格式返回，从而实现国漫的“无人值守”自动化下载。

MVP（最小可行产品）范围清晰地聚焦于核心的自动化处理流程、用户认证及基础配置功能。

### 1.2. 技术可行性总体评价

从技术角度看，本项目可行性高。主要工作是作为中间件，对上游（Sonarr）和下游（TMDB、Prowlarr）的API进行集成与数据处理。

- **核心挑战**：在于“解析搜索结果”的准确性和覆盖面。中文资源发布命名格式多样，需要设计一套健壮且可扩展的解析引擎。
- **性能要求**：PRD提出的2秒内响应时间是合理的，通过异步IO和适当的缓存策略可以轻松满足。
- **依赖稳定性**：项目强依赖第三方API，方案设计中必须充分考虑其不可用或变更时的降级与容错策略。

总体评价为：**技术风险可控，目标明确，可以启动开发。**

## 2\. 系统架构设计

我们将采用一个简单、高效的单体式应用（Monolith）架构。对于MVP阶段的应用规模和功能复杂度而言，这是最务实、开发和部署效率最高的选择，可以避免过早引入微服务带来的复杂性。

### 2.1. 架构图

使用Mermaid代码描述如下，清晰地展示了两个主要流程：用户配置流程和自动化处理流程。

```mermaid
graph TD
    subgraph 用户 (浏览器)
        A[Web UI/SPA]
    end

    subgraph Queqiao-arr 服务 (Docker 容器)
        B[Nginx/Web服务器]
        C[后端API (FastAPI)]
        D[SQLite 数据库]
        E{自动化处理引擎}
        F[TMDB API 客户端]
        G[Prowlarr API 客户端]
        H[标题解析器]
        I[Torznab XML 生成器]
    end

    subgraph 外部服务
        J[Sonarr]
        K[Prowlarr]
        L[TMDB API]
    end

    %% 用户配置流程
    A -- HTTP/HTTPS --> B
    B -- REST API 请求 (登录/保存设置) --> C
    C -- 读/写 (加密凭据) --> D

    %% 自动化处理流程 (核心)
    J -- 1. Torznab API 搜索请求 --> B
    B -- 2. 转发请求 --> E
    E -- 3. 查询剧集别名 --> F
    F -- 4. 访问外部API (可选代理) --> L
    E -- 5. 使用中文别名查询 --> G
    G -- 6. 访问Prowlarr API --> K
    E -- 7. 获取原始结果列表 --> H
    H -- 8. 解析标题 --> E
    E -- 9. 封装成标准格式 --> I
    I -- 10. 生成Torznab XML --> E
    E -- 11. XML响应 --> J
```

### 2.2. 核心模块划分与职责说明

- **Web UI (Frontend)**: 基于现代前端框架构建的单页应用（SPA）。负责提供用户注册、登录、Sonarr/Prowlarr/代理配置的图形化界面。
- **Web服务器/反向代理 (Nginx)**: 作为前端静态资源服务器和后端API的反向代理，处理SSL等。
- **后端API (Backend)**:
    - **用户与配置模块**: 提供用户认证、会话管理、以及所有配置（API密钥、URL、代理）的CRUD接口。所有敏感信息在存入数据库前必须加密。
    - **Torznab API模块**: 实现Sonarr兼容的Torznab API端点。这是整个自动化流程的入口。
- **自动化处理引擎 (Core Logic)**:
    - **编排器**: 接收到Torznab请求后，依次调用TMDB客户端、Prowlarr客户端，并将结果交给解析器处理，最后封装成XML响应。
    - **TMDB API客户端**: 负责与TMDB API通信，获取剧集的中文别名，内置请求重试和缓存机制。
    - **Prowlarr API客户端**: 负责向Prowlarr发起搜索请求。
    - **标题解析器**: **（本项目技术核心）** 使用正则表达式和启发式算法，从 `[VCB-Studio][斗罗大陆][156][1080p]` 这类标题中提取剧集名、季号、集号、质量等关键信息。
- **数据库 (Database)**: 存储用户账户、哈希后的密码，以及加密存储的API密钥和代理配置。

## 3\. 技术栈选型

| 类别 | 技术/工具 | 选型理由 | 备选方案 (Plan B) |
| :--- | :--- | :--- | :--- |
| **前端** | **Vue 3 + TypeScript** | 开发体验好，生态成熟，对于以表单为主的配置页面开发效率高。TS提供类型安全。 | React |
| | **Element Plus** (UI库) | 组件丰富，设计统一，能快速构建美观的界面。 | Naive UI |
| | **SCSS** (样式预处理) | 提供变量、嵌套、混入等高级CSS特性，便于维护复杂样式和主题切换。 | Less/Stylus |
| | **Tailwind CSS** (原子化CSS) | 原子化类名设计，快速构建响应式界面，与Element Plus完美互补。 | UnoCSS |
| | **Vite** (构建工具) | 极速的开发服务器启动和热更新，构建速度快。 | Webpack |
| | **Pinia** (状态管理) | Vue 3官方推荐，轻量、简洁、类型友好。 | - |
| **后端** | **Python 3.11+** | 胶水语言特性非常适合API集成和数据处理任务，生态丰富，开发速度快。 | Go |
| | **FastAPI** (Web框架) | 性能高（基于Starlette和Pydantic），自带交互式API文档（Swagger UI），支持异步，类型提示友好，非常适合构建API服务。 | Flask |
| | **SQLAlchemy 2.0** (ORM) | 成熟强大的ORM，与FastAPI集成良好，支持异步操作。 | SQLModel |
| **数据库** | **SQLite** | 轻量级文件数据库，无需单独部署服务，完美契合本项目单用户、轻量级、Docker化部署的场景，极大简化了用户部署流程。 | PostgreSQL |
| **基础设施** | **Docker & Docker Compose** | PRD明确依赖。实现环境一致性，简化部署和分发流程，是此类自托管服务的最佳实践。 | - |
| | **Nginx** | 作为Web服务器和反向代理，性能卓越，配置灵活，稳定可靠。 | Caddy |
| **DevOps** | **GitHub Actions** (CI/CD) | 与代码仓库无缝集成，可自动化完成测试、Lint、Docker镜像构建和推送到Docker Hub/GHCR。 | GitLab CI/CD |
| | **Ruff / Black / Mypy** | 用于Python代码的Linting、格式化和静态类型检查，保障代码质量。 | - |
| **第三方服务** | **TMDB API** | PRD指定，中文元数据支持良好。 | - |

## 4\. 开发任务分解 (WBS - Work Breakdown Structure)

采用人日（Person-Day）估算，并考虑了开发、自测和代码评审的时间。

| 模块 | 任务名称 | 复杂度 (T-Shirt) | 估算人日 (PD) | 依赖 |
| :--- | :--- | :--- | :--- | :--- |
| **0. 项目基础 (Foundation)** | 初始化项目结构，配置CI/CD流水线 | S | 2 | - |
| | 搭建Docker & Docker Compose本地开发环境 | S | 1 | - |
| **1. 后端 (Backend)** | 用户认证模块 (注册、登录、JWT) API | M | 3 | 项目基础 |
| | 配置模块 (Sonarr, Prowlarr, 代理) API，含加密存储 | M | 3 | 项目基础 |
| | TMDB API 客户端封装与测试 | M | 3 | - |
| | Prowlarr API 客户端封装与测试 | S | 2 | - |
| | **核心：标题解析器 V1 (支持常见格式)** | **XL** | **8** | - |
| | **核心：Torznab XML 生成与响应模块** | **L** | **5** | - |
| | **核心：端到端自动化引擎编排逻辑** | L | 4 | 客户端/解析器 |
| **2. 前端 (Frontend)** | 搭建Vue项目，集成UI库和路由 | S | 1 | 项目基础 |
| | 注册/登录页面开发与API联调 | M | 3 | 后端认证API |
| | 主设置页面 (Sonarr, Prowlarr, 代理) 开发与API联调 | L | 5 | 后端配置API |
| **3. 集成与测试** | 前后端完整流程联调 | M | 3 | 前/后端开发 |
| | 编写核心模块单元测试 (解析器、API客户端) | L | 4 | 核心模块开发 |
| | 编写端到端集成测试脚本 (模拟Sonarr请求) | L | 4 | 核心模块开发 |
| | 编写用户使用文档和部署指南 | M | 2 | - |
| **缓冲/Buffer** | 预留用于处理意外问题和技术攻关 | - | 7 | - |
| **总计** | | | **60 PD** | |

## 5\. 里程碑 (Milestone) 与发布计划

项目周期按PRD要求为 **3个月**。

- **第一月 (Week 1-4): 完成基础架构与配置闭环**

    - **目标:** 完成项目搭建、CI/CD、后端用户认证和配置API、前端所有UI页面开发及联调。
    - **验收标准:** 用户可以部署应用，成功注册登录，并能在UI上保存和读取所有配置项。自动化引擎尚未工作。
    - **产出:** 可交互但无核心功能的Alpha原型。

- **第二月 (Week 5-8): 攻坚核心引擎**

    - **目标:** 完成TMDB/Prowlarr客户端、标题解析器和Torznab XML生成模块的开发与单元测试。
    - **验收标准:** 自动化处理引擎能够独立运行，通过单元测试和集成测试，能正确处理模拟的Sonarr请求并返回预期的XML结果。
    - **产出:** 功能完整的内部测试版（Alpha）。

- **第三月 (Week 9-12): 集成、测试与发布**

    - **目标:** 进行端到端测试，修复Bug，完善文档，进行小范围用户内测。
    - **验收标准:** 国漫剧集自动匹配成功率达到80%的目标，配置流程顺畅，文档清晰。
    - **产出:**
        - **Week 11:** Beta公测版发布。
        - **Week 12:** V1.0正式版发布。

## 6\. 团队组成与资源需求

- **团队组成:**

    - **后端工程师 x1**: 负责所有后端逻辑、API开发、数据库和DevOps。
    - **前端工程师 x1**: 负责所有Web UI的开发。
    - **测试工程师/角色 x0.5**: 可由两位工程师交叉承担，负责测试用例设计和执行。
    - **项目负责人 (我)**: 负责技术决策、进度跟踪和风险管理。
    - **结论：** 核心团队需要 **2名** 专职工程师。

- **资源需求:**

    - **软件/服务:**
        - GitHub私有仓库（或使用公司代码托管）。
        - Docker Hub组织账号用于分发镜像。
        - TMDB API Key（需提前申请）。
    - **硬件:** 无特殊硬件需求，开发人员标准设备即可。

## 7\. 已知风险与应对策略

- **技术风险:**

    - **风险点:** 中文标题解析的复杂性和多样性可能超出预期，导致80%的成功率难以达成。
    - **应对策略:**
        1.  **迭代开发:** MVP阶段只覆盖最高频的几种命名格式，保证核心可用。
        2.  **日志先行:** 对所有无法解析的标题记录详细日志，便于后续分析和迭代改进解析规则。
        3.  **V2规划:** PRD中已规划了手动干预和自定义规则，这是最终解决长尾问题的根本之道，MVP阶段不必追求完美。

- **第三方依赖风险:**

    - **风险点:** TMDB、Prowlarr或Sonarr的API发生变更、服务不可用或速率限制。
    - **应对策略:**
        1.  **封装客户端:** 将所有对外的API调用封装在独立的客户端模块中，便于未来统一修改。
        2.  **健壮的错误处理:** 实现完善的超时、重试（带指数退避）机制。
        3.  **降级策略:** 当TMDB查询失败时，应能自动降级为使用Sonarr的原始英文标题进行搜索，保证部分功能可用。
        4.  **缓存:** 对TMDB的查询结果进行短时间（如24小时）缓存，降低API调用频率和延迟。

- **安全与合规风险:**

    - **风险点:** 用户的Sonarr/Prowlarr API Key、密码等敏感信息存储不当导致泄露。
    - **应对策略:**
        1.  **密码哈希:** 用户密码必须使用强哈希算法（如Argon2）加盐存储。
        2.  **凭据加密:** 所有第三方服务的API Key和代理密码，在存入数据库时，必须使用对称加密（如AES-256-GCM），密钥通过环境变量或外部密钥管理服务注入。**严禁明文存储。**
        3.  **Docker安全:** 基础镜像使用官方的、经过扫描的镜像。应用以非root用户运行。